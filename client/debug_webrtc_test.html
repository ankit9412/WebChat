<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #059669;
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 WebRTC Connection Test</h1>
        <p>This tool tests WebRTC connectivity and helps identify connection issues.</p>
        
        <div>
            <button onclick="testSTUNServers()">Test STUN Servers</button>
            <button onclick="testMediaAccess()">Test Camera/Microphone</button>
            <button onclick="testNetworkConnectivity()">Test Network</button>
            <button onclick="testSocketConnection()">Test Socket.IO</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let logElement = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[WebRTC Test] ${message}`);
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        async function testSTUNServers() {
            log('🧊 Testing STUN servers...', 'info');
            
            const stunServers = [
                'stun:stun.l.google.com:19302',
                'stun:stun1.l.google.com:19302', 
                'stun:stun2.l.google.com:19302',
                'stun:stun.relay.metered.ca:80',
                'stun:global.stun.twilio.com:3478'
            ];
            
            for (const stunUrl of stunServers) {
                try {
                    log(`Testing ${stunUrl}...`, 'info');
                    
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: stunUrl }]
                    });
                    
                    const testPromise = new Promise((resolve, reject) => {
                        let candidateFound = false;
                        const timeout = setTimeout(() => {
                            if (!candidateFound) {
                                reject(new Error('Timeout'));
                            }
                        }, 5000);
                        
                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                candidateFound = true;
                                clearTimeout(timeout);
                                resolve(event.candidate);
                            }
                        };
                        
                        pc.onicegatheringstatechange = () => {
                            if (pc.iceGatheringState === 'complete' && !candidateFound) {
                                clearTimeout(timeout);
                                reject(new Error('No candidates found'));
                            }
                        };
                    });
                    
                    // Create a dummy offer to start ICE gathering
                    await pc.createOffer({ offerToReceiveAudio: true });
                    
                    const candidate = await testPromise;
                    log(`✅ ${stunUrl} - Working! Type: ${candidate.type}`, 'success');
                    
                    pc.close();
                } catch (error) {
                    log(`❌ ${stunUrl} - Failed: ${error.message}`, 'error');
                }
            }
            
            log('🧊 STUN server test completed', 'info');
        }
        
        async function testMediaAccess() {
            log('📹 Testing media access...', 'info');
            
            try {
                // Test audio only
                log('Testing audio access...', 'info');
                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                log('✅ Audio access granted', 'success');
                audioStream.getTracks().forEach(track => track.stop());
                
                // Test video
                log('Testing video access...', 'info');
                const videoStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                log('✅ Video access granted', 'success');
                log(`📊 Tracks: ${videoStream.getTracks().length} (${videoStream.getAudioTracks().length} audio, ${videoStream.getVideoTracks().length} video)`, 'info');
                videoStream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                log(`❌ Media access failed: ${error.name} - ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('⚠️ Camera/microphone permission denied. Please enable in browser settings.', 'warning');
                } else if (error.name === 'NotFoundError') {
                    log('⚠️ No camera/microphone found.', 'warning');
                }
            }
        }
        
        async function testNetworkConnectivity() {
            log('🌐 Testing network connectivity...', 'info');
            
            // Test basic internet connectivity
            try {
                const response = await fetch('https://www.google.com/generate_204', { 
                    method: 'GET', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                log('✅ Internet connectivity working', 'success');
            } catch (error) {
                log('❌ Internet connectivity failed', 'error');
            }
            
            // Test backend connection
            try {
                const response = await fetch('http://localhost:5001/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'test'}`
                    }
                });
                log(`📡 Backend connection: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'warning');
            } catch (error) {
                log(`❌ Backend connection failed: ${error.message}`, 'error');
            }
        }
        
        function testSocketConnection() {
            log('🔌 Testing Socket.IO connection...', 'info');
            
            const socket = io('http://localhost:5001');
            let connectionTimeout = setTimeout(() => {
                log('❌ Socket connection timeout', 'error');
                socket.disconnect();
            }, 10000);
            
            socket.on('connect', () => {
                clearTimeout(connectionTimeout);
                log(`✅ Socket connected: ${socket.id}`, 'success');
                
                // Test basic message
                socket.emit('test-message', { timestamp: Date.now() });
                
                setTimeout(() => {
                    socket.disconnect();
                    log('🔌 Socket disconnected', 'info');
                }, 2000);
            });
            
            socket.on('connect_error', (error) => {
                clearTimeout(connectionTimeout);
                log(`❌ Socket connection error: ${error.message}`, 'error');
            });
            
            socket.on('disconnect', (reason) => {
                log(`🔌 Socket disconnected: ${reason}`, 'warning');
            });
        }
        
        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            log('🚀 WebRTC Test Tool Loaded', 'success');
            log('Click the buttons above to run specific tests', 'info');
        });
    </script>
</body>
</html>